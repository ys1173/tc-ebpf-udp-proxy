# test-deployment.yaml — udp-fanout + 3 receiver pods for k3s testing
#
# Prerequisites:
#   kubectl apply -f k8s/rbac.yaml   (namespace + serviceaccount + RBAC)
#
# Apply:
#   kubectl apply -f k8s/test-deployment.yaml

---
# ConfigMap: udp-fanout configuration for TC eBPF mode
apiVersion: v1
kind: ConfigMap
metadata:
  name: udp-fanout-config
  namespace: udp-fanout
  labels:
    app.kubernetes.io/name: udp-fanout
data:
  config.yaml: |
    listeners:
      - name: udp-logs
        bind: "0.0.0.0:40514"
        interface: eno1
        mode: tc_ebpf
        kubernetes:
          namespace: udp-fanout
          service: udp-receivers
          port: 40514
    health:
      enabled: true
      interval_secs: 5
      timeout_secs: 2
      protocol: icmp
    metrics:
      enabled: false

---
# DaemonSet: udp-fanout with hostNetwork + eBPF capabilities
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: udp-fanout
  namespace: udp-fanout
  labels:
    app.kubernetes.io/name: udp-fanout
    app.kubernetes.io/component: proxy
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: udp-fanout
  template:
    metadata:
      labels:
        app.kubernetes.io/name: udp-fanout
    spec:
      serviceAccountName: udp-fanout
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      tolerations:
        - operator: Exists
      containers:
        - name: udp-fanout
          image: docker.io/library/udp-fanout:latest
          imagePullPolicy: Never
          args:
            - "--config"
            - "/etc/udp-fanout/config.yaml"
            - "--ebpf-program"
            - "/opt/udp-fanout/udp-fanout-ebpf"
            - "--log-level"
            - "info"
          securityContext:
            privileged: false
            capabilities:
              add:
                - BPF
                - NET_ADMIN
                - SYS_ADMIN
                - PERFMON
              drop:
                - ALL
          resources:
            requests:
              cpu: "100m"
              memory: "64Mi"
            limits:
              cpu: "2"
              memory: "256Mi"
          volumeMounts:
            - name: config
              mountPath: /etc/udp-fanout
              readOnly: true
            - name: bpffs
              mountPath: /sys/fs/bpf
            - name: debugfs
              mountPath: /sys/kernel/debug
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: udp-fanout-config
        - name: bpffs
          hostPath:
            path: /sys/fs/bpf
            type: DirectoryOrCreate
        - name: debugfs
          hostPath:
            path: /sys/kernel/debug
            type: Directory

---
# ConfigMap: Vector receiver configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-receiver-config
  namespace: udp-fanout
data:
  vector.yaml: |
    sources:
      udp_in:
        type: socket
        address: "0.0.0.0:40514"
        mode: udp
        max_length: 65536
    sinks:
      blackhole:
        type: blackhole
        inputs: ["udp_in"]
        print_interval_secs: 2
    api:
      enabled: true
      address: "0.0.0.0:8686"

---
# Deployment: 3 Vector receiver pods (UDP → blackhole with stats)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: udp-receiver
  namespace: udp-fanout
  labels:
    app.kubernetes.io/name: udp-receiver
spec:
  replicas: 3
  selector:
    matchLabels:
      app: udp-receiver
  template:
    metadata:
      labels:
        app: udp-receiver
    spec:
      containers:
        - name: vector
          image: docker.io/timberio/vector:latest-alpine
          imagePullPolicy: Never
          args: ["--config", "/etc/vector/vector.yaml"]
          ports:
            - containerPort: 40514
              protocol: UDP
            - containerPort: 8686
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /etc/vector
              readOnly: true
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"
      volumes:
        - name: config
          configMap:
            name: vector-receiver-config

---
# Headless Service: creates EndpointSlices for udp-fanout k8s discovery
apiVersion: v1
kind: Service
metadata:
  name: udp-receivers
  namespace: udp-fanout
  labels:
    app.kubernetes.io/name: udp-receiver
spec:
  clusterIP: None
  selector:
    app: udp-receiver
  ports:
    - name: udp-logs
      port: 40514
      targetPort: 40514
      protocol: UDP
